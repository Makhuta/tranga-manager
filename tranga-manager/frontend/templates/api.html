{% extends "base.html" %}

{% block title %}{{ api }}{% endblock %}

{% block content %}
<header>
    <nav class="navbar navbar-expand-lg tertiary-color accent-color px-2">
        <div class="collapse navbar-collapse" id="navbarNavDropdown">
            <ul class="navbar-nav mr-auto mt-2 mt-lg-0">
                <li class="nav-item dropdown my-auto">
                    <b>{{ api }}</b>
                </li>
                <li class="nav-item dropdown pl-2 my-auto">
                    <div class="loader" style="--loader-size: 24px; --loader-color: #3498db; --loader-bg: #f3f3f3;" id="loader_icon"></div>
                    <i id="result_icon" style="font-size:24px"></i>
                </li>
                <li class="nav-item dropdown pl-5">
                    <a href="{% url 'api_monitor' api.pk%}">
                        <button class="btn btn-outline-warning my-2 my-sm-0" type="submit">Monitor <i class="fa fa-eye"></i></button>
                    </a>
                </li>
            </ul>
            <form class="form-inline my-2 my-lg-0" id="delete-form" method="post" action="{% url 'api_delete' api.pk%}">
                {% csrf_token %}
                <button class="btn btn-outline-danger my-2 my-sm-0" type="submit">Delete <i class="fa fa-trash"></i></button>
            </form>
        </div>
    </nav>
</header>
<main class="p-4">
    <table class="w-100">
        <tbody id="jobs_table">
        </tbody>
    </table>
</main>
{% endblock %}


{% block scripts %}
<script>
    function testConnection(ip, port) {
        let loadingDiv = document.getElementById("loader_icon");
        let resultDiv = document.getElementById("result_icon");

        if(loadingDiv.hidden) {
            loadingDiv.style.display = "initial";
        }

        if(!resultDiv.hidden) {
            resultDiv.style.display = "hidden";
            resultDiv.classList.remove("fa", "fa-check", "fas", "fa-times");
        }

        if (!ip || !port) {
            resultDiv.classList.add("fas", "fa-times");
            return;
        }

        fetch(`{% url 'test' %}?ip=${ip}&port=${port}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    resultDiv.classList.add("fa", "fa-check");
                    loadingDiv.style.display = "none";
                    resultDiv.style.display = "initial";
                } else {
                    resultDiv.classList.add("fas", "fa-times");
                    loadingDiv.style.display = "none";
                    resultDiv.style.display = "initial";
                }
            })
            .catch(error => {
                resultDiv.classList.add("fas", "fa-times");
                loadingDiv.style.display = "none";
                resultDiv.style.display = "initial";
            });
        setTimeout(() => {
            testConnection(ip, port);
        }, 60000);
    }

    async function fetchData(address, d=[]) {
        try {
            let response = await fetch(address);
            let data = await response.json();
            return data.success;
        }
        catch (error){
            return d;
        }
    }

    function create_row(item, url, pk) {
        const tr = document.createElement("tr");
        tr.classList.add("altering");
        const a = document.createElement("a");
        a.classList.add("py-2");
        a.style.textDecoration = "inherit";
        a.style.color = "inherit";
        a.style.cursor = "auto";
        a.href = `${url}?internalId=${item.manga.internalId}`;
        tr.appendChild(a);

        const tableRow = document.createElement("table");
        tableRow.classList.add("tg", "w-100", "h-100", "m-2")

        tableRow.innerHTML = `
        <tbody>
            <tr>
                <td style="cursor: pointer;"><img src="{% url 'manga_cover' %}?pk=${pk}&internalId=${item.manga.internalId}" style="width: 10em; max-height: 15em;"></img></td>
                <td class="h-100 w-100 p-2" style="height: 100%;">
                    <table class="h-100 w-100">
                        <tbody>
                            <tr>
                                <td class="w-75" colspan="4" style="cursor: pointer;">${item.manga.sortName}</td>
                                <td class="w-25">(${item.manga.status})</td>
                            </tr>
                            <tr>
                                <td colspan="3">
                                    <b>Description: </b></br>
                                    ${item.manga.description.substring(0, 512) + (item.manga.description.length > 512 ? "..." : "")}
                                </td>
                                <td colspan="2"></td>
                            </tr>
                            <tr>
                                <td colspan="4"><b>Tags: </b>${Object.keys(item.manga.tags).slice(0, 32).map((key) => item.manga.tags[key]).join(", ")}</td>
                                <td></td>
                            </tr>
                            <tr>
                                <td colspan="4"></td>
                                <td></td>
                            </tr>
                            <tr>
                                <td><a href="${item.manga.websiteUrl}">${item.mangaConnector.name}</a></td>
                                <td colspan="2"></td>
                                <td colspan="2">${Object.keys(item.manga.authors).slice(0, 32).map((key) => item.manga.authors[key]).join(", ")}</td>
                            </tr>
                        </tbody>
                    </table>
                </td>
            </tr>
        </tbody>
        `;
        a.appendChild(tableRow);

        return tr;
    }

    async function getMonitors(url, url_api, pk) {
        let jobs_div = document.getElementById(`jobs_table`);

        let data = await fetchData(url, []);

        let newChildren = [];
        data.forEach(item => {
            newChildren.push(create_row(item, url_api, pk));
        });


        jobs_div.replaceChildren(...newChildren);


        setTimeout(() => {
            getMonitors(url, url_api, pk);
        }, 60000);
    }

    testConnection("{{ api.ip }}","{{ api.port }}");
    getMonitors("{% url 'jobs_monitor' api.pk %}", "{% url 'manga' api.pk %}", "{{ api.pk }}");
</script>
{% endblock %}
